<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NASA Mission: The Lost Data</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --terminal-bg: #010413;
            --terminal-glow: rgba(0, 255, 255, 0.7);
            --terminal-text: #00ffff;
            --border-color: rgba(0, 255, 255, 0.5);
            --danger-glow: rgba(255, 80, 80, 0.9);
            --success-glow: rgba(80, 255, 150, 0.9);
            --flare-color: #ffcc00;
        }
        body {
            font-family: 'Share Tech Mono', monospace;
            background: var(--terminal-bg);
            color: var(--terminal-text);
            overflow: hidden;
        }
        .scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
            background: linear-gradient(to bottom, rgba(255,255,255,0) 0%, rgba(255,255,255,0) 98%, rgba(255,255,255,0.05) 100%);
            background-size: 100% 3px; animation: scan 10s linear infinite;
        }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .terminal-panel {
            background: rgba(5, 20, 30, 0.9); border: 2px solid var(--border-color);
            box-shadow: 0 0 25px var(--terminal-glow), inset 0 0 15px rgba(0, 255, 255, 0.1);
            transition: all 0.3s ease-in-out; padding: 2rem;
            backdrop-filter: blur(5px);
        }
        .btn-primary {
            background: transparent; border: 2px solid var(--border-color);
            color: var(--terminal-text); text-shadow: 0 0 8px var(--terminal-glow);
            transition: all 0.3s ease;
        }
        .btn-primary:hover { background: rgba(0, 255, 255, 0.1); box-shadow: 0 0 20px var(--terminal-glow); }
        .hidden { display: none; }
        .typewriter-cursor { animation: blink 0.7s steps(2, start) infinite; }
        canvas { background-color: transparent; border: 2px solid var(--border-color); image-rendering: pixelated; }
        
        /* Solar System Map Styles  */
        .solar-system-map { position: relative; width: 100%; height: 500px; }
        .orbit { position: absolute; border: 1px dotted rgba(0, 255, 255, 0.3); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .celestial-body { position: absolute; border-radius: 50%; cursor: pointer; transition: all 0.3s ease; }
        .celestial-body:hover { transform: scale(1.2); filter: brightness(1.5); }
        .celestial-body.completed { filter: grayscale(50%) brightness(0.8); cursor: not-allowed; }
        #map-sun-base { top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100px; height: 100px; background: radial-gradient(circle, #fff7a1, #f9d71c, #ff8c00); box-shadow: 0 0 60px #f9d71c, 0 0 80px orange; animation: pulse-sun 4s infinite; }
        #map-sun-interactive { top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100px; height: 100px; cursor: not-allowed; border: 3px dashed rgba(255, 100, 100, 0.5); }
        #map-sun-interactive.unlocked { cursor: pointer; border: 3px solid var(--terminal-text); animation: pulse-green 2s infinite; }
        #map-mercury { top: 50%; left: 38%; transform: translate(-50%, -50%); width: 18px; height: 18px; background: radial-gradient(circle, #d1ccc0, #b0a99f, #817b75); }
        #map-mars { top: 48%; left: 25%; transform: translate(-50%, -50%); width: 25px; height: 25px; background: radial-gradient(circle, #ff8b8b, #ff6b6b, #c1440e); }
        #map-jupiter { top: 55%; left: 80%; transform: translate(-50%, -50%); width: 50px; height: 50px; background: radial-gradient(circle, #f5d6b4, #e0c097, #c6a778); }
        #map-saturn { top: 25%; left: 90%; transform: translate(-50%, -50%); width: 45px; height: 45px; background: radial-gradient(circle, #e0cfb1, #d3b991, #b7a685); }
        #map-saturn::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%) rotate(20deg); width: 160%; height: 90%; border: 4px solid #b7a685; border-radius: 50%; box-shadow: 0 0 10px #d3b991; }
        .body-label { position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%); color: white; white-space: nowrap; text-shadow: 0 0 5px black; }

        @keyframes blink { to { visibility: hidden; } }
        @keyframes scan { from { background-position: 0 0; } to { background-position: 0 -100px; } }
        @keyframes pulse-green { 0% { box-shadow: 0 0 15px var(--terminal-glow); } 50% { box-shadow: 0 0 35px var(--terminal-glow); } 100% { box-shadow: 0 0 15px var(--terminal-glow); } }
        @keyframes pulse-sun { 0% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 60px #f9d71c; } 50% { transform: translate(-50%, -50%) scale(1.05); box-shadow: 0 0 90px orange; } 100% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 60px #f9d71c; } }
        @keyframes screenShake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">
    <div class="scanlines"></div>
    <canvas id="starfield-bg" class="fixed top-0 left-0 w-full h-full -z-10"></canvas>

    <main id="game-container" class="w-full max-w-4xl mx-auto p-4">
        <!-- Start Screen -->
        <div id="start-screen" class="terminal-panel rounded-lg text-center">
            <h1 id="main-title" class="font-orbitron text-4xl md:text-5xl font-bold mb-4 text-center"></h1>
            <p class="text-lg md:text-xl text-gray-300 mb-8 opacity-0" id="start-subtitle">Agent, lost data fragments have been detected across the solar system. Your mission is to visit each celestial body, overcome the system corruption by completing mini-games, and recover the data.</p>
            <button id="start-btn" class="btn-primary font-orbitron text-2xl px-12 py-4 rounded-md opacity-0">Initialize Mission</button>
        </div>

        <!-- Map Screen -->
        <div id="map-screen" class="hidden terminal-panel rounded-lg">
             <h2 class="font-orbitron text-3xl mb-4 text-center">Solar System Navigation</h2>
             <p class="text-lg text-center mb-6">Recover all planetary data to unlock the final challenge at the Sun. <span id="completed-planets">0</span>/<span id="total-planets">4</span> recovered.</p>
             <div class="solar-system-map">
                <div class="orbit" style="width: 20%; height: 20%;"></div>
                <div class="orbit" style="width: 40%; height: 40%;"></div>
                <div class="orbit" style="width: 70%; height: 70%;"></div>
                <div class="orbit" style="width: 95%; height: 95%;"></div>
                <div id="map-sun-base" class="celestial-body !cursor-default" ></div>
                <div id="map-sun-interactive" class="celestial-body" data-planet="sun"><span class="body-label">Sun [LOCKED]</span></div>
                <div id="map-mercury" class="celestial-body" data-planet="mercury"><span class="body-label">Mercury</span></div>
                <div id="map-mars" class="celestial-body" data-planet="mars"><span class="body-label">Mars</span></div>
                <div id="map-jupiter" class="celestial-body" data-planet="jupiter"><span class="body-label">Jupiter</span></div>
                <div id="map-saturn" class="celestial-body" data-planet="saturn"><span class="body-label">Saturn</span></div>
             </div>
        </div>
        
        <!-- Sun Minigame: Solar Flare Evasion -->
        <div id="sun-minigame-screen" class="hidden terminal-panel rounded-lg text-center">
            <h2 class="font-orbitron text-3xl mb-2">Sun: Solar Flare Evasion</h2>
            <p class="text-lg mb-4">Orbit the sun and survive the solar flares for 45 seconds! Use [LEFT] & [RIGHT] arrows.</p>
            <canvas id="sun-canvas" width="700" height="400"></canvas>
             <div class="flex justify-between text-lg mt-2 px-4">
                <span>Shield Integrity: <span id="sun-shield">100</span>%</span>
                <span>Time Left: <span id="sun-timer">45</span>s</span>
            </div>
        </div>

        <!-- Mercury Minigame: Signal Relay -->
        <div id="mercury-minigame-screen" class="hidden terminal-panel rounded-lg text-center">
            <h2 class="font-orbitron text-3xl mb-2">Mercury: Signal Relay</h2>
            <p class="text-lg mb-4">Repeat the signal sequence to align the relays. Status: <span id="mercury-status">WATCHING</span></p>
            <canvas id="mercury-canvas" width="700" height="400"></canvas>
            <div class="flex justify-between text-lg mt-2 px-4">
                <span>Sequence Length: <span id="mercury-level">1</span></span>
                <span>Strikes: <span id="mercury-strikes">0</span>/3</span>
            </div>
        </div>

        <!-- Mars Minigame: Asteroid Recovery -->
        <div id="mars-minigame-screen" class="hidden terminal-panel rounded-lg text-center">
            <h2 class="font-orbitron text-3xl mb-2">Mars: Asteroid Data Recovery</h2>
            <p class="text-lg mb-4">Collect <span id="mars-packets-to-collect">12</span> data packets. Avoid corrupt fragments!</p>
            <canvas id="mars-canvas" width="700" height="400"></canvas>
            <div class="flex justify-between text-lg mt-2 px-4">
                <span>Packets: <span id="mars-packets-collected">0</span></span>
                <span>Time: <span id="mars-timer">30</span>s</span>
            </div>
        </div>
        
        <!-- Jupiter Minigame: Storm Navigation -->
        <div id="jupiter-minigame-screen" class="hidden terminal-panel rounded-lg text-center">
            <h2 class="font-orbitron text-3xl mb-2">Jupiter: Storm Navigation</h2>
            <p class="text-lg mb-4">Survive the storm for 35 seconds. Use [SPACE] to activate shields.</p>
            <canvas id="jupiter-canvas" width="700" height="400"></canvas>
             <div class="flex justify-between text-lg mt-2 px-4">
                <span>Shield Energy: <span id="jupiter-shield">100</span>%</span>
                <span>Time: <span id="jupiter-timer">35</span>s</span>
            </div>
        </div>

        <!-- Saturn Minigame: Ring Gap Navigation -->
        <div id="saturn-minigame-screen" class="hidden terminal-panel rounded-lg text-center">
            <h2 class="font-orbitron text-3xl mb-2">Saturn: Ring Gap Navigation</h2>
            <p class="text-lg mb-4">Navigate through 12 gaps in the rings. Use [UP] & [DOWN] arrows.</p>
            <canvas id="saturn-canvas" width="700" height="400"></canvas>
             <div class="flex justify-between text-lg mt-2 px-4">
                <span>Gaps Cleared: <span id="saturn-gaps">0</span>/12</span>
                <span>Hull Integrity: <span id="saturn-hull">100</span>%</span>
            </div>
        </div>

        <!-- Data Recovered Screen -->
        <div id="data-recovered-screen" class="hidden terminal-panel rounded-lg">
            <h2 class="font-orbitron text-3xl mb-4 text-center">DATA FRAGMENT RECOVERED</h2>
            <div class="flex flex-col md:flex-row items-center gap-8">
                <div id="planet-info-art" class="w-48 h-48 flex-shrink-0"></div>
                <div>
                    <h3 id="planet-info-name" class="font-orbitron text-2xl mb-2"></h3>
                    <p id="planet-info-text" class="text-lg"></p>
                </div>
            </div>
             <button id="continue-btn" class="btn-primary font-orbitron text-xl px-10 py-3 rounded-md mt-6 w-full">Return to Nav</button>
        </div>

        <!-- End Screen -->
        <div id="end-screen" class="hidden terminal-panel rounded-lg text-center">
            <h1 id="end-title" class="font-orbitron text-5xl font-bold mb-4"></h1>
            <p id="end-message" class="text-xl mb-4"></p>
            <p class="text-3xl font-bold mb-8">Final Score: <span id="final-score">0</span></p>
            <button id="restart-btn" class="btn-primary font-orbitron text-2xl px-12 py-4 rounded-md">Re-initialize</button>
        </div>

         <!-- Sound Control -->
         <button id="sound-toggle" class="absolute top-4 right-4 text-white p-2 rounded-full" style="background:rgba(5, 20, 30, 0.9); border-color: var(--border-color);"><svg id="sound-on-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg><svg id="sound-off-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l-4-4m0 4l4-4" /></svg></button>
    </main>

    <script>
        const screens = {
            start: document.getElementById('start-screen'),
            map: document.getElementById('map-screen'),
            sunMinigame: document.getElementById('sun-minigame-screen'),
            mercuryMinigame: document.getElementById('mercury-minigame-screen'),
            marsMinigame: document.getElementById('mars-minigame-screen'),
            jupiterMinigame: document.getElementById('jupiter-minigame-screen'),
            saturnMinigame: document.getElementById('saturn-minigame-screen'),
            dataRecovered: document.getElementById('data-recovered-screen'),
            end: document.getElementById('end-screen')
        };
        const mainTitleEl = document.getElementById('main-title');
        const startSubtitleEl = document.getElementById('start-subtitle');
        const startBtn = document.getElementById('start-btn');
        const restartBtn = document.getElementById('restart-btn');
        const finalScoreEl = document.getElementById('final-score');
        const endTitleEl = document.getElementById('end-title');
        const endMessageEl = document.getElementById('end-message');
        const soundToggle = document.getElementById('sound-toggle');
        const soundOnIcon = document.getElementById('sound-on-icon');
        const soundOffIcon = document.getElementById('sound-off-icon');
        const planetInfoArtEl = document.getElementById('planet-info-art');
        const planetInfoNameEl = document.getElementById('planet-info-name');
        const planetInfoTextEl = document.getElementById('planet-info-text');
        const continueBtn = document.getElementById('continue-btn');
        const completedPlanetsEl = document.getElementById('completed-planets');
        const totalPlanetsEl = document.getElementById('total-planets');

        const recoveredData = {
             sun: {
                name: "The Sun",
                art: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="45" fill="#f9d71c" /><circle cx="50" cy="50" r="40" fill="orange" /><circle cx="50" cy="50" r="35" fill="yellow" /></svg>`,
                text: "The heart of our solar system. A nearly perfect sphere of hot plasma, its gravity holds the solar system together. You've recovered the core data and saved the network. Mission accomplished, agent."
            },
            mercury: {
                name: "Mercury",
                art: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="45" fill="#9d9d9d" /><circle cx="25" cy="30" r="8" fill="#7e7e7e" /><circle cx="65" cy="70" r="12" fill="#7e7e7e" /></svg>`,
                text: "The smallest planet in our Solar System and nearest to the Sun, it has the widest temperature extremes, swinging from scorching hot to freezing cold."
            },
            mars: {
                name: "Mars",
                art: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="45" fill="#c1440e" /><circle cx="60" cy="65" r="10" fill="#a52a2a" /><circle cx="35" cy="55" r="5" fill="#a52a2a" /></svg>`,
                text: "Also known as the Red Planet, its color comes from iron oxide on its surface. Home to Olympus Mons, the largest volcano in the solar system."
            },
            jupiter: {
                 name: "Jupiter",
                 art: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="45" fill="#e0c097" /><rect x="20" y="40" width="60" height="10" fill="#c6a778" /><rect x="25" y="60" width="50" height="8" fill="#d3b389" /></svg>`,
                 text: "The largest planet in our Solar System. Its iconic Great Red Spot is a gigantic storm that has raged for centuries. It is a gas giant, composed primarily of hydrogen and helium."
            },
            saturn: {
                 name: "Saturn",
                 art: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="35" fill="#d3b991"/><ellipse cx="50" cy="50" rx="48" ry="15" stroke="#b7a685" stroke-width="5" fill="none" transform="rotate(-20 50 50)" /></svg>`,
                 text: "The second-largest planet, adorned with a dazzling, complex system of icy rings. Saturn is a gas giant with an average density less than waterâ€”it would float in a large enough bathtub."
            }
        };

        let score = 0, isSoundOn = false;
        let activeGameCleanup = null;
        let particles = [];
        const PLAYER_SHIP_SVG = `<svg width="20" height="25" viewBox="0 0 20 25" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10 0L20 25H0L10 0Z" fill="#00ffff"/><path d="M10 15L15 25H5L10 15Z" fill="white"/></svg>`;
        const playerShipImage = new Image();
        playerShipImage.src = "data:image/svg+xml;base64," + btoa(PLAYER_SHIP_SVG);


        const celestialBodies = {
            mercury: { isComplete: false },
            mars: { isComplete: false },
            jupiter: { isComplete: false },
            saturn: { isComplete: false },
            sun: { isComplete: false }
        };

        const synth = new Tone.Synth().toDestination();
        const backgroundMusic = new Tone.Loop(time => synth.triggerAttackRelease("C2", "8n", time), "1n");

        function playSound(type, note = "C4", duration = "16n") {
            if (!isSoundOn) return; Tone.start();
            const notes = { correct: "C5", incorrect: "G2", click: "C4", collect: "A5", hit: "A2", shield: "G4", sequence: "E5", win: "G5" };
            synth.triggerAttackRelease(notes[type] || note, duration);
        }

        function toggleSound() {
            isSoundOn = !isSoundOn;
            if (isSoundOn) { Tone.start(); Tone.Transport.start(); backgroundMusic.start(0); soundOnIcon.classList.remove('hidden'); soundOffIcon.classList.add('hidden'); } 
            else { backgroundMusic.stop(); Tone.Transport.stop(); soundOnIcon.classList.add('hidden'); soundOffIcon.classList.remove('hidden'); }
        }

        function typeWriter(element, text, speed = 25, callback = () => {}) {
            let i = 0; element.innerHTML = "";
            const cursor = document.createElement('span'); cursor.className = 'typewriter-cursor'; cursor.innerHTML = '&#9646;'; element.appendChild(cursor);
            function type() { if (i < text.length) { element.insertBefore(document.createTextNode(text.charAt(i)), cursor); i++; setTimeout(type, speed); } else { cursor.remove(); callback(); } }
            type();
        }
        
        function switchScreen(toScreen) {
            if (activeGameCleanup) { activeGameCleanup(false, true); } // Cleanup previous game if any
            Object.values(screens).forEach(s => s.classList.add('hidden'));
            if(screens[toScreen]) screens[toScreen].classList.remove('hidden');
        }
        
        function showWinIndicator(canvas, callback) {
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = "rgba(0,0,0,0.7)";
            ctx.fillRect(0,0,canvas.width, canvas.height);
            ctx.font = "bold 50px Orbitron";
            ctx.fillStyle = "var(--terminal-text)";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.shadowColor = 'var(--terminal-glow)';
            ctx.shadowBlur = 20;
            ctx.fillText("CHALLENGE COMPLETE", canvas.width / 2, canvas.height / 2);
            ctx.shadowBlur = 0;
            playSound('win');
            setTimeout(callback, 2000);
        }

        function createParticles(x, y, count, color) {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x, y,
                    vx: (Math.random() - 0.5) * 4,
                    vy: (Math.random() - 0.5) * 4,
                    size: Math.random() * 3 + 1,
                    life: Math.random() * 50 + 20,
                    color: color
                });
            }
        }

        function updateAndDrawParticles(ctx) {
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.x += p.vx; p.y += p.vy; p.life--;
                ctx.fillStyle = p.color;
                ctx.globalAlpha = p.life / 50;
                ctx.fillRect(p.x, p.y, p.size, p.size);
                if (p.life <= 0) particles.splice(i, 1);
            }
            ctx.globalAlpha = 1;
        }

        // === New function for the info overlay ===
        function createPlanetInfoOverlay(planetKey, gameScreenId) {
            const data = recoveredData[planetKey];
            const gameScreen = document.getElementById(gameScreenId);

            const overlay = document.createElement('div');
            overlay.id = `${planetKey}-info-overlay`;
            overlay.className = 'absolute inset-0 flex items-center justify-center bg-gray-900 bg-opacity-90 z-20';
            overlay.innerHTML = `
                <div class="terminal-panel rounded-lg p-6 w-3/4 max-w-lg text-left">
                    <div class="flex flex-col md:flex-row items-center gap-6">
                        <div class="w-24 h-24 flex-shrink-0">
                            ${data.art}
                        </div>
                        <div>
                            <h3 class="font-orbitron text-xl mb-2 text-yellow-300">${data.name} Data Fragment</h3>
                            <p class="text-sm text-gray-300">${data.text}</p>
                        </div>
                    </div>
                    <button id="close-overlay-btn" class="btn-primary font-orbitron text-sm px-6 py-2 rounded-md mt-4 w-full">Continue Mission</button>
                </div>
            `;

            gameScreen.appendChild(overlay);
            document.getElementById('close-overlay-btn').onclick = () => overlay.remove();
        }

        function bootUpAnimation() {
            typeWriter(mainTitleEl, "NASA Mission: The Lost Data", 75, () => {
                startSubtitleEl.style.transition = 'opacity 1s'; startSubtitleEl.classList.remove('opacity-0');
                startBtn.style.transition = 'opacity 1s 0.5s'; startBtn.classList.remove('opacity-0');
            });
        }
        
        function startGame() {
            score = 0;
            Object.keys(celestialBodies).forEach(key => celestialBodies[key].isComplete = false);
            updateMapScreen();
            switchScreen('map');
        }
        
        function updateMapScreen() {
            let completedCount = 0;
            const totalPlanets = Object.keys(celestialBodies).length - 1; // Exclude Sun from count
            Object.keys(celestialBodies).forEach(key => {
                const planetEl = document.querySelector(`.celestial-body[data-planet="${key}"]`);
                if (key !== 'sun' && celestialBodies[key].isComplete) {
                    planetEl.classList.add('completed');
                    completedCount++;
                } else if (key !== 'sun') {
                    planetEl.classList.remove('completed');
                }
            });
            completedPlanetsEl.textContent = completedCount;
            totalPlanetsEl.textContent = totalPlanets;
            
            const sunEl = document.getElementById('map-sun-interactive');
            const sunLabel = sunEl.querySelector('.body-label');
            if (completedCount === totalPlanets) {
                sunEl.classList.add('unlocked');
                sunLabel.textContent = "Sun [UNLOCKED]";
            } else {
                 sunEl.classList.remove('unlocked');
                 sunLabel.textContent = "Sun [LOCKED]";
            }
            if(celestialBodies.sun.isComplete){
                endGame(true, "All data fragments recovered! You are a hero!");
            }
        }

        function showDataRecovered(planetKey) {
            switchScreen('dataRecovered');
            const data = recoveredData[planetKey];
            planetInfoArtEl.innerHTML = data.art;
            typeWriter(planetInfoNameEl, data.name, 100, () => {
                typeWriter(planetInfoTextEl, data.text, 25);
            });
        }

        function endGame(isComplete, message) {
            switchScreen('end');
            endTitleEl.style.textShadow = isComplete ? "" : `0 0 15px var(--danger-glow)`;
            typeWriter(endTitleEl, isComplete ? "Mission Complete" : "Mission Failed", 100, () => {
                endMessageEl.textContent = message;
                finalScoreEl.textContent = score;
            });
        }
        
        // --- SUN MINIGAME ---
        function launchSunMinigame() {
            switchScreen('sunMinigame');
            const canvas = document.getElementById('sun-canvas'); const ctx = canvas.getContext('2d');
            const shieldEl = document.getElementById('sun-shield'); const timerEl = document.getElementById('sun-timer');
            let player = { angle: 0, radius: 150, size: 20, speed: 0.05 };
            let keys = {}, flares = [], shield = 100, timer = 45;
            const sunPos = { x: canvas.width/2, y: canvas.height/2 };
            
            const keydownHandler = e => keys[e.key] = true; const keyupHandler = e => keys[e.key] = false;
            document.addEventListener('keydown', keydownHandler); document.addEventListener('keyup', keyupHandler);
            
            const gameLoop = () => {
                if (keys['ArrowLeft']) player.angle -= player.speed;
                if (keys['ArrowRight']) player.angle += player.speed;
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Draw Sun
                const sunGradient = ctx.createRadialGradient(sunPos.x, sunPos.y, 20, sunPos.x, sunPos.y, 60);
                sunGradient.addColorStop(0, '#fff7a1'); sunGradient.addColorStop(0.5, '#f9d71c'); sunGradient.addColorStop(1, 'rgba(255, 140, 0, 0)');
                ctx.fillStyle = sunGradient; ctx.beginPath(); ctx.arc(sunPos.x, sunPos.y, 60, 0, Math.PI*2); ctx.fill();
                
                // Draw Player
                const playerX = sunPos.x + Math.cos(player.angle) * player.radius;
                const playerY = sunPos.y + Math.sin(player.angle) * player.radius;
                ctx.drawImage(playerShipImage, playerX - player.size/2, playerY - player.size/2, player.size, player.size * 1.25);
                
                // Update and Draw Flares
                flares.forEach((f, i) => {
                    f.dist += f.speed;
                    const flareX = sunPos.x + Math.cos(f.angle) * f.dist;
                    const flareY = sunPos.y + Math.sin(f.angle) * f.dist;
                    const flareGradient = ctx.createRadialGradient(flareX, flareY, 1, flareX, flareY, f.size);
                    flareGradient.addColorStop(0, 'white'); flareGradient.addColorStop(0.4, '#ffcc00'); flareGradient.addColorStop(1, 'rgba(255, 0, 0, 0)');
                    ctx.fillStyle = flareGradient; ctx.beginPath(); ctx.arc(flareX, flareY, f.size, 0, Math.PI*2); ctx.fill();
                    
                    if (f.dist > canvas.width) flares.splice(i,1);
                    const distToPlayer = Math.sqrt(Math.pow(playerX - flareX, 2) + Math.pow(playerY - flareY, 2));
                    if (distToPlayer < (player.size/2 + f.size/2)) {
                        flares.splice(i,1); shield -= 25; shieldEl.textContent = `${shield}%`; playSound('hit');
                        createParticles(playerX, playerY, 30, '#ff5050');
                        canvas.style.animation = 'screenShake 0.2s'; setTimeout(()=>canvas.style.animation='', 200);
                        if (shield <= 0) cleanup(false);
                    }
                });
                updateAndDrawParticles(ctx);
            };

            const gameInterval = setInterval(gameLoop, 1000/60);
            const flareInterval = setInterval(() => flares.push({angle: Math.random()*Math.PI*2, dist: 70, speed: Math.random()*2+2, size: Math.random() * 10 + 10}), 400);
            const timerInterval = setInterval(() => { timer--; timerEl.textContent = timer; if(timer <= 0) cleanup(true); }, 1000);
            
            const cleanup = (success, silent = false) => {
                 clearInterval(gameInterval); clearInterval(flareInterval); clearInterval(timerInterval);
                 document.removeEventListener('keydown', keydownHandler); document.removeEventListener('keyup', keyupHandler); activeGameCleanup = null;
                 if(silent) return;
                 if(success) {
                    showWinIndicator(canvas, () => {
                        score += 200; celestialBodies.sun.isComplete = true; showDataRecovered('sun');
                    });
                 } else { switchScreen('map'); }
            };
            activeGameCleanup = cleanup;
        }

        // --- MERCURY MINIGAME ---
        function launchMercuryMinigame() {
            switchScreen('mercuryMinigame');
            const canvas = document.getElementById('mercury-canvas'); const ctx = canvas.getContext('2d');
            const levelEl = document.getElementById('mercury-level'); const strikesEl = document.getElementById('mercury-strikes'); const statusEl = document.getElementById('mercury-status');
            const colors = ['#ff5050', '#fef08a', '#00ffff', '#50b0ff'];
            const pads = [ {x:150, y:50, w:200, h:150, r:15}, {x:350, y:50, w:200, h:150, r:15}, {x:150, y:200, w:200, h:150, r:15}, {x:350, y:200, w:200, h:150, r:15} ];
            let sequence = [], playerSequence = [], strikes = 0, state = 'watching', goal = 7;
            function drawPads(activeIndex = -1, pulse = 0) {
                ctx.clearRect(0,0,canvas.width, canvas.height);
                pads.forEach((p, i) => {
                    ctx.fillStyle = colors[i];
                    ctx.shadowBlur = 20;
                    ctx.shadowColor = colors[i];
                    ctx.globalAlpha = (i === activeIndex) ? 1.0 : 0.6;
                    ctx.beginPath();
                    ctx.roundRect(p.x, p.y, p.w, p.h, [p.r]);
                    ctx.fill();
                });
                 ctx.shadowBlur = 0; ctx.globalAlpha = 1.0;
            }
            function nextSequence() {
                state = 'watching'; statusEl.textContent = 'WATCHING'; playerSequence = []; sequence.push(Math.floor(Math.random()*4)); levelEl.textContent = sequence.length;
                let i = 0;
                const interval = setInterval(() => {
                    playSound('sequence', ['C4','E4','G4','B4'][sequence[i]], '8n'); drawPads(sequence[i]); setTimeout(() => drawPads(), 300); i++;
                    if(i >= sequence.length) { clearInterval(interval); state = 'playing'; statusEl.textContent = 'YOUR TURN'; }
                }, 500);
            }
            const clickHandler = (e) => {
                if(state !== 'playing') return;
                const rect = canvas.getBoundingClientRect(); const x = e.clientX - rect.left; const y = e.clientY - rect.top;
                const clickedPad = pads.findIndex(p => x > p.x && x < p.x + p.w && y > p.y && y < p.y + p.h);
                if(clickedPad > -1) {
                    playSound('click', ['C4','E4','G4','B4'][clickedPad], '8n'); drawPads(clickedPad); setTimeout(() => drawPads(), 200); playerSequence.push(clickedPad);
                    createParticles(x,y, 20, colors[clickedPad]);
                    if(playerSequence[playerSequence.length-1] !== sequence[playerSequence.length-1]) {
                        strikes++; strikesEl.textContent = `${strikes}/3`; playSound('incorrect');
                        canvas.style.animation = 'screenShake 0.2s'; setTimeout(()=>canvas.style.animation='', 200);
                        if(strikes >= 3) { cleanup(false); } else { state='watching'; setTimeout(nextSequence, 1000); }
                    } else if(playerSequence.length === sequence.length) {
                        if(sequence.length >= goal) { cleanup(true); } else { state='watching'; setTimeout(nextSequence, 1000); }
                    }
                }
            };
            canvas.addEventListener('click', clickHandler);
            const particleLoop = setInterval(()=>updateAndDrawParticles(ctx), 1000/60);
            const cleanup = (success, silent = false) => {
                canvas.removeEventListener('click', clickHandler); clearInterval(particleLoop); activeGameCleanup = null;
                if(silent) return;
                if(success) { showWinIndicator(canvas, () => { score += 75; celestialBodies.mercury.isComplete = true; showDataRecovered('mercury'); }); } else { switchScreen('map'); }
            };
            activeGameCleanup = cleanup; drawPads(); nextSequence();
        }
        
        // --- MARS MINIGAME ---
        function launchMarsMinigame() {
            switchScreen('marsMinigame');
            const canvas = document.getElementById('mars-canvas'); const ctx = canvas.getContext('2d');
            const packetsCollectedEl = document.getElementById('mars-packets-collected');
            const timerEl = document.getElementById('mars-timer');
            let player = { x: canvas.width / 2 - 15, y: canvas.height - 40, width: 20, height: 25, speed: 5 };
            let keys = {}, dataPackets = [], obstacles = [], collected = 0, timer = 30, goal = 12;
            const keydownHandler = e => keys[e.key] = true; const keyupHandler = e => keys[e.key] = false;
            document.addEventListener('keydown', keydownHandler); document.addEventListener('keyup', keyupHandler);
            const gameLoop = () => {
                if (keys['ArrowLeft'] && player.x > 0) player.x -= player.speed; if (keys['ArrowRight'] && player.x < canvas.width - player.width) player.x += player.speed;
                ctx.clearRect(0, 0, canvas.width, canvas.height); 
                
                if(Math.random() < 0.2) createParticles(player.x + player.width/2, player.y + player.height, 1, '#ffffff'); // Engine trail

                ctx.drawImage(playerShipImage, player.x, player.y, player.width, player.height);
                
                dataPackets.forEach((p, i) => { p.y += 2.5; ctx.fillStyle = '#00ffff'; ctx.shadowColor = '#00ffff'; ctx.shadowBlur=15; ctx.fillRect(p.x, p.y, 10, 10); ctx.shadowBlur=0; if(p.y > canvas.height) dataPackets.splice(i,1); if(p.x < player.x+player.width && p.x+10 > player.x && p.y < player.y+player.height && p.y+10 > player.y){dataPackets.splice(i,1); collected++; playSound('collect'); createParticles(p.x, p.y, 20, '#00ffff'); if (collected === 4 || collected === 8) { if (!document.getElementById('mars-info-overlay')) { createPlanetInfoOverlay('mars', 'mars-minigame-screen'); } } } });
                obstacles.forEach((o, i) => { o.y += 3.5; ctx.fillStyle = '#ff5050'; ctx.shadowColor = '#ff5050'; ctx.shadowBlur=15; ctx.beginPath(); ctx.moveTo(o.x, o.y); ctx.lineTo(o.x+15, o.y+5); ctx.lineTo(o.x+5, o.y+15); ctx.closePath(); ctx.fill(); ctx.shadowBlur=0; if(o.y > canvas.height) obstacles.splice(i,1); if(o.x < player.x+player.width && o.x+15 > player.x && o.y < player.y+player.height && o.y+15 > player.y){playSound('hit'); createParticles(o.x, o.y, 20, '#ff5050'); cleanup(false);} });
                
                updateAndDrawParticles(ctx);
                packetsCollectedEl.textContent = collected; if(collected >= goal) cleanup(true);
            };
            const gameInterval = setInterval(gameLoop, 1000/60); const packetInterval = setInterval(() => dataPackets.push({x:Math.random()*canvas.width, y:-10}), 700); const obstacleInterval = setInterval(() => obstacles.push({x:Math.random()*canvas.width, y:-10}), 1000); const timerInterval = setInterval(() => { timer--; timerEl.textContent = timer; if(timer <= 0) cleanup(false); }, 1000);
            const cleanup = (success, silent = false) => {
                clearInterval(gameInterval); clearInterval(packetInterval); clearInterval(obstacleInterval); clearInterval(timerInterval);
                document.removeEventListener('keydown', keydownHandler); document.removeEventListener('keyup', keyupHandler); activeGameCleanup = null;
                if(silent) return; if(success) { showWinIndicator(canvas, () => { score += 50; celestialBodies.mars.isComplete = true; showDataRecovered('mars'); }); } else { switchScreen('map'); }
            };
            activeGameCleanup = cleanup;
        }

        // --- JUPITER MINIGAME ---
        function launchJupiterMinigame() {
             switchScreen('jupiterMinigame');
             const canvas = document.getElementById('jupiter-canvas'); const ctx = canvas.getContext('2d');
             const shieldEl = document.getElementById('jupiter-shield'); const timerEl = document.getElementById('jupiter-timer');
             let player = { x: 50, y: canvas.height/2-10, width: 20, height: 25 }; let bolts = [], shield = 100, timer = 35, isShielding = false;
             const keydownHandler = e => { if(e.code === 'Space' && shield > 0) isShielding = true; }; const keyupHandler = e => { if(e.code === 'Space') isShielding = false; };
             document.addEventListener('keydown', keydownHandler); document.addEventListener('keyup', keyupHandler);
             const gameLoop = () => {
                ctx.fillStyle = 'rgba(1, 4, 19, 0.2)'; ctx.fillRect(0,0,canvas.width, canvas.height); // Motion blur
                if(isShielding) { shield -= 0.8; if(shield < 0) { shield=0; isShielding=false; } playSound('shield', 'G3', '32n'); } else if(shield < 100) { shield += 0.08; }
                shieldEl.textContent = Math.floor(shield); 
                
                ctx.drawImage(playerShipImage, player.x, player.y, player.width, player.height);

                if(isShielding){ 
                    const shieldGradient = ctx.createRadialGradient(player.x+player.width/2, player.y+player.height/2, 10, player.x+player.width/2, player.y+player.height/2, 25);
                    shieldGradient.addColorStop(0, 'rgba(0, 255, 255, 0.8)');
                    shieldGradient.addColorStop(1, 'rgba(0, 255, 255, 0)');
                    ctx.fillStyle = shieldGradient;
                    ctx.beginPath(); ctx.arc(player.x+player.width/2, player.y+player.height/2, 25, 0, Math.PI*2); ctx.fill();
                }

                bolts.forEach((b, i) => { 
                    b.x -= 6; 
                    ctx.strokeStyle = '#fef08a'; ctx.lineWidth = 3; ctx.shadowColor='#fef08a'; ctx.shadowBlur=20;
                    ctx.beginPath(); ctx.moveTo(b.x, b.y);
                    for(let j = 0; j < b.segments.length; j++) { ctx.lineTo(b.x + b.segments[j].x, b.y + b.segments[j].y); }
                    ctx.stroke(); ctx.shadowBlur = 0;

                    if(b.x < -b.w) bolts.splice(i,1); 
                    const hit = b.x < player.x+player.width && b.x+b.w > player.x && b.y > player.y && b.y < player.y + player.height;
                    if(hit && !isShielding){ playSound('hit'); cleanup(false); } else if (hit && isShielding) { bolts.splice(i,1); playSound('click'); }
                });
             };
            const gameInterval = setInterval(gameLoop, 1000/60); 
            const boltInterval = setInterval(() => {
                const bolt = {x:canvas.width, y:Math.random()*canvas.height, w:Math.random()*40+30, segments: []};
                let lastY = 0;
                for(let i=0; i<5; i++){
                    lastY += (Math.random()-0.5)*10;
                    bolt.segments.push({x: i * (bolt.w/5), y: lastY });
                }
                bolts.push(bolt);
            }, 400); 
            const timerInterval = setInterval(() => { timer--; timerEl.textContent = timer; if (timer === 25 || timer === 15) { if (!document.getElementById('jupiter-info-overlay')) { createPlanetInfoOverlay('jupiter', 'jupiter-minigame-screen'); } } if(timer <= 0) cleanup(true); }, 1000);
            const cleanup = (success, silent = false) => {
                 clearInterval(gameInterval); clearInterval(boltInterval); clearInterval(timerInterval); document.removeEventListener('keydown', keydownHandler); document.removeEventListener('keyup', keyupHandler); activeGameCleanup = null;
                 if(silent) return; if(success) { showWinIndicator(canvas, () => { score += 100; celestialBodies.jupiter.isComplete = true; showDataRecovered('jupiter'); }); } else { switchScreen('map'); }
            };
            activeGameCleanup = cleanup;
        }
        
        // --- SATURN MINIGAME ---
        function launchSaturnMinigame() {
            switchScreen('saturnMinigame');
            const canvas = document.getElementById('saturn-canvas'); const ctx = canvas.getContext('2d');
            const gapsEl = document.getElementById('saturn-gaps'); const hullEl = document.getElementById('saturn-hull');
            let player = { x: 50, y: canvas.height / 2 - 10, width: 20, height: 25, speed: 5 };
            let keys = {}, rings = [], gapsCleared = 0, hull = 100, goal = 12;
            const keydownHandler = e => keys[e.key] = true; const keyupHandler = e => keys[e.key] = false;
            document.addEventListener('keydown', keydownHandler); document.addEventListener('keyup', keyupHandler);
            const gameLoop = () => {
                if (keys['ArrowUp'] && player.y > 0) player.y -= player.speed; if (keys['ArrowDown'] && player.y < canvas.height - player.height) player.y += player.speed;
                ctx.clearRect(0, 0, canvas.width, canvas.height); 
                ctx.drawImage(playerShipImage, player.x, player.y, player.width, player.height);
                rings.forEach((r, i) => {
                    r.x -= 3.5; 
                    ctx.fillStyle = '#b7a685';
                    ctx.globalAlpha = r.alpha;
                    ctx.fillRect(r.x, r.y, r.width, r.height);
                    ctx.globalAlpha = 1;

                    if (r.x + r.width < 0) { rings.splice(i, 1); }
                    if (r.isGap && r.x + r.width < player.x && !r.passed) { r.passed = true; gapsCleared++; gapsEl.textContent = `${gapsCleared}/${goal}`; playSound('correct'); if (gapsCleared === 3 || gapsCleared === 6 || gapsCleared === 9) { if (!document.getElementById('saturn-info-overlay')) { createPlanetInfoOverlay('saturn', 'saturn-minigame-screen'); } } }
                    
                    const hit = !r.isGap && player.x + player.width > r.x && player.x < r.x + r.width && player.y + player.height > r.y && player.y < r.y + r.height;
                    if(hit) { hull -= 25; hullEl.textContent = `${hull}%`; playSound('hit'); createParticles(player.x, player.y, 20, '#ffaa00'); rings.splice(i,1); if(hull <=0) cleanup(false); }
                });
                updateAndDrawParticles(ctx);
                if (gapsCleared >= goal) cleanup(true);
            };
            const gameInterval = setInterval(gameLoop, 1000/60); 
            const ringInterval = setInterval(() => {
                const gapY = Math.random()*(canvas.height-110);
                const gapHeight = 110;
                let lastGap = false;
                for(let i=0; i<canvas.height; i+=10){
                    if (i < gapY || i > gapY + gapHeight) {
                        rings.push({ x: canvas.width, y: i, width: Math.random()*15+10, height: 8, alpha: Math.random()*0.5+0.3 });
                    } else if (!lastGap) {
                        rings.push({x: canvas.width, isGap:true, passed: false, width: 25});
                        lastGap = true;
                    }
                }
            }, 1800);
            const cleanup = (success, silent = false) => {
                clearInterval(gameInterval); clearInterval(ringInterval); document.removeEventListener('keydown', keydownHandler); document.removeEventListener('keyup', keyupHandler); activeGameCleanup = null;
                if(silent) return; if(success) { showWinIndicator(canvas, () => { score += 75; celestialBodies.saturn.isComplete = true; showDataRecovered('saturn'); }); } else { switchScreen('map'); }
            };
            activeGameCleanup = cleanup;
        }

        // Event Listeners
        startBtn.addEventListener('click', () => { screens.start.classList.add('hidden'); startGame(); });
        restartBtn.addEventListener('click', () => { switchScreen('start'); bootUpAnimation(); });
        soundToggle.addEventListener('click', toggleSound);
        continueBtn.addEventListener('click', () => { switchScreen('map'); updateMapScreen(); });
        document.querySelectorAll('.celestial-body[data-planet]').forEach(p => {
            p.addEventListener('click', () => {
                const planetKey = p.dataset.planet;
                if (celestialBodies[planetKey] && !celestialBodies[planetKey].isComplete) {
                    if (planetKey === 'mercury') launchMercuryMinigame();
                    if (planetKey === 'mars') launchMarsMinigame();
                    if (planetKey === 'jupiter') launchJupiterMinigame();
                    if (planetKey === 'saturn') launchSaturnMinigame();
                    if (planetKey === 'sun' && document.getElementById('map-sun-interactive').classList.contains('unlocked')) launchSunMinigame();
                }
            });
        });
        
        // Background starfield
        const starfield = document.getElementById('starfield-bg'); const ctx = starfield.getContext('2d');
        let stars = [];
        function resizeCanvas() {
            starfield.width = window.innerWidth; starfield.height = window.innerHeight; stars = [];
            for (let i = 0; i < 300; i++) { stars.push({ x: Math.random() * starfield.width, y: Math.random() * starfield.height, radius: Math.random() * 1.5, alpha: Math.random(), vx: -0.1 + Math.random() * 0.3 }); }
        }
        function animateStars() {
            ctx.clearRect(0, 0, starfield.width, starfield.height);
            stars.forEach(star => {
                star.x += star.vx; if (star.x < 0) star.x = starfield.width; if (star.x > starfield.width) star.x = 0;
                ctx.beginPath(); ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2); ctx.fillStyle = `rgba(255, 255, 255, ${star.alpha})`; ctx.fill();
            });
            requestAnimationFrame(animateStars);
        }
        window.addEventListener('resize', resizeCanvas); resizeCanvas(); animateStars(); bootUpAnimation();
    </script>
</body>
</html>


